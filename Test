# --- Configuration ---
$EpmServer = "na207.epm.cyberark.com" # Your specific dispatcher
$SAMLResponse = "PHNhbWxwOl... (Your very long Base64 string from IdP)"

# --- 1. Exchange SAML Response for EPM Token ---
$SamlUrl = "https://$EpmServer/SAML/Logon"

# SAML authentication requires Form Data (application/x-www-form-urlencoded)
$Body = @{
    SAMLResponse = $SAMLResponse
}

try {
    Write-Host "Exchanging SAML Response for EPM Session..." -ForegroundColor Cyan
    # Note: Use -ContentType to ensure the server parses the form data correctly
    $AuthResponse = Invoke-RestMethod -Uri $SamlUrl -Method Post -Body $Body -ContentType "application/x-www-form-urlencoded"
    
    # Extract the token and the specific Manager URL
    $SessionToken = $AuthResponse.EPMAuthenticationResult
    $ManagerUrl   = $AuthResponse.ManagerURL 
    
    Write-Host "SAML Authentication Successful!" -ForegroundColor Green
    Write-Host "Manager URL: $ManagerUrl" -ForegroundColor Gray
}
catch {
    Write-Host "SAML Authentication Failed. Check if the SAML response has expired." -ForegroundColor Red
    $Err = $_.Exception.Message
    if ($_.ErrorDetails) { $Err += " - " + $_.ErrorDetails }
    Write-Host "Reason: $Err" -ForegroundColor Yellow
    return
}

# --- 2. Action (Call Manager URL) ---
$Headers = @{
    "Authorization" = "basic $SessionToken" # Still uses "basic " lowercase prefix
    "Content-Type"  = "application/json"
}

$SetsUrl = "$ManagerUrl/EPM/API/Sets"
$SetsResponse = Invoke-RestMethod -Uri $SetsUrl -Method Get -Headers $Headers

Write-Host "Connected successfully. Sets found: $($SetsResponse.Sets.Count)" -ForegroundColor Cyan
$SetsResponse.Sets | Format-Table Name, SetId
