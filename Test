# --- Configuration ---
$EpmServer = "na207.epm.cyberark.com" # Updated to your specific dispatcher
$AppId     = "API_Automation"        # You can keep this as is
$Username  = "Your_Local_EPM_User"   # The EPM user you created manually
$Password  = 'Your_Local_Password'   # Use single quotes to handle special characters

# --- 1. Authentication (Login to Dispatcher) ---
$AuthUrl = "https://$EpmServer/EPM/API/Auth/EPM/Logon"
$AuthBody = @{
    Username      = $Username
    Password      = $Password
    ApplicationId = $AppId
} | ConvertTo-Json

try {
    Write-Host "Connecting to Dispatcher: $EpmServer..." -ForegroundColor Cyan
    # Perform the logon request
    $AuthResponse = Invoke-RestMethod -Uri $AuthUrl -Method Post -Body $AuthBody -ContentType "application/json"
    
    # Capture the specific ManagerURL assigned to your session
    $SessionToken = $AuthResponse.EPMAuthenticationResult
    $ManagerUrl   = $AuthResponse.ManagerURL 
    
    Write-Host "Authentication Successful!" -ForegroundColor Green
    Write-Host "Redirected to Manager: $ManagerUrl" -ForegroundColor Gray
}
catch {
    Write-Host "Authentication Failed!" -ForegroundColor Red
    # [cite_start]Display detailed error message for troubleshooting [cite: 31, 32]
    $Err = $_.Exception.Message
    if ($_.ErrorDetails) { $Err += " - " + ($_.ErrorDetails | ConvertFrom-Json).ErrorMessage }
    Write-Host "Reason: $Err" -ForegroundColor Yellow
    return
}

# --- 2. Sample Action (Call Manager URL) ---
$Headers = @{
    "Authorization" = "basic $SessionToken" # Must be lowercase "basic"
    "Content-Type"  = "application/json"
}

try {
    # Get the list of Sets using the dynamic ManagerUrl
    $SetsUrl = "$ManagerUrl/EPM/API/Sets"
    $SetsResponse = Invoke-RestMethod -Uri $SetsUrl -Method Get -Headers $Headers
    
    Write-Host "Available EPM Sets:" -ForegroundColor Cyan
    $SetsResponse.Sets | Format-Table Name, SetId, Description
}
catch {
    Write-Host "API Call Failed. Ensure you have 'Allow to manage sets' permission." -ForegroundColor Red
}
