# --- Configuration ---
$EpmServer = "na171.epm.cyberark.com" # Your Dispatcher URL
$AppId     = "My_Automation_Tool"     # Your custom Application ID
$Username  = "Your_EPM_User"           # EPM User created in Step 1
$Password  = "Your_Password"           # EPM User Password

# --- 1. Authentication (Login to Dispatcher) ---
$AuthUrl = "https://$EpmServer/EPM/API/Auth/EPM/Logon"
$AuthBody = @{
    Username      = $Username
    Password      = $Password
    ApplicationId = $AppId
} | ConvertTo-Json

try {
    Write-Host "Connecting to Dispatcher: $EpmServer..." -ForegroundColor Cyan
    $AuthResponse = Invoke-RestMethod -Uri $AuthUrl -Method Post -Body $AuthBody -ContentType "application/json"
    
    # IMPORTANT: Use the ManagerURL returned by the server, NOT the Dispatcher URL
    $SessionToken = $AuthResponse.EPMAuthenticationResult
    $ManagerUrl   = $AuthResponse.ManagerURL 
    
    Write-Host "Login Successful!" -ForegroundColor Green
    Write-Host "Assigned Manager URL: $ManagerUrl" -ForegroundColor Gray
}
catch {
    Write-Host "Authentication Failed. Please check credentials and Dispatcher URL." -ForegroundColor Red
    Write-Error $_
    return
}

# --- 2. Action (Call Manager URL) ---
# Example: Retrieving EPM Sets
$TargetUrl = "$ManagerUrl/EPM/API/Sets"

# Authorization header must be lowercase "basic " followed by the token
$Headers = @{
    "Authorization" = "basic $SessionToken"
    "Content-Type"  = "application/json"
}

try {
    Write-Host "Fetching data from Manager..." -ForegroundColor Cyan
    $DataResponse = Invoke-RestMethod -Uri $TargetUrl -Method Get -Headers $Headers
    
    # Display the results
    if ($DataResponse.Sets) {
        $DataResponse.Sets | Format-Table -Property Name, SetId, Description
    } else {
        Write-Host "No sets found or unexpected response format." -ForegroundColor Yellow
        $DataResponse | ConvertTo-Json
    }
}
catch {
    # If this fails with the same error, ensure $ManagerUrl is being used
    Write-Host "Action Failed. Ensure you are not bypassing the Manager URL." -ForegroundColor Red
    Write-Error $_
}
